!function(_){"use strict";var e={_inputLatId:"",_inputLngId:"",_mapWrapperId:"",_mapSearchId:"",_mapCanvasId:"",_zoomLevel:16,_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",init:function(e){var i=this;i._params=e,i._inputLatSel="woocommerce_wcsdm_origin_lat",i._inputLngSel="woocommerce_wcsdm_origin_lng",i._mapWrapperSel="wcsdm-map-wrapper",i._mapSearchSel="wcsdm-map-search",i._mapCanvasSel="wcsdm-map-canvas",i._gmapsAPIKey=null,i._gmapsAPIKeyInput=null,i._gmapsAPIKeyFieldset=null,i._parentApiKeyActivator=null,i._gmapsAPIKeyField=null,i._gmapsAPIKeyFieldSibling=null,i._gmapsAPIKey=null,i._saveBtn=null,i._plainApiKey=null,i._loaderSpinner=null,i._validateApiBtn=null,i._changeApiBtn=null,i._tableRows=null,i._invalidApiKeyMessage=null,i._params.show_settings&&setTimeout(function(){for(var e=!1,t=_(document).find(".wc-shipping-zone-method-type"),n=0;n<t.length;n++){var a=t[n];if(_(a).text()===i._params.method_title)return _(a).closest("tr").find(".row-actions .wc-shipping-zone-method-settings").trigger("click"),void(e=!0)}e||(_(".wc-shipping-zone-add-method").trigger("click"),_('select[name="add_method_id"]').val(i._params.method_id).trigger("change"))},200),_(document).on("click",".wc-shipping-zone-method-settings",function(){if(_(this).closest("tr").find(".wc-shipping-zone-method-type").text()!==i._params.method_title)return!1;_("#woocommerce_wcsdm_gmaps_api_units").trigger("change"),i._initSettingElements(),i._gmapsAPIKey.length?(i._changeApiBtn.show(),i._gmapsAPIKeyField.hide(),i._plainApiKey.text(i._gmapsAPIKey),i._plainApiKey.show(),i._saveBtn.show(),i._gmapsAPIKey=i._gmapsAPIKey,i._initGoogleMaps()):(i._validateApiBtn.show(),i._plainApiKey.text(""),i._plainApiKey.hide(),i._tableRows.hide(),i._saveBtn.hide())}),_(document).on("click","#wcsdm-api-key-validator",function(e){e.preventDefault();var t=_(this),n=_("#woocommerce_wcsdm_gmaps_api_key").val();_(".notice-error");t.prop("disabled",!0),i._invalidApiKeyMessage.hide(),i._loaderSpinner.show(),n.length?new Promise(function(e,t){i._gmapsAPIKey===n&&e(n),i._validateGmapAPIkey(n,e,t)}).then(function(e){t.prop("disabled",!1),i._loaderSpinner.hide(),i._tableRows.hide(),i._gmapsAPIKeyInput.hide(),i._validateApiBtn.hide(),i._plainApiKey.text(n),i._plainApiKey.show(),i._changeApiBtn.show(),i._tableRows.show(),i._saveBtn.show(),i._gmapsAPIKey!==n&&(i._destroyGoogleMaps(),i._gmapsAPIKey=n),i._initGoogleMaps()}).catch(function(e){t.prop("disabled",!1),i._loaderSpinner.hide(),i._changeApiBtn.hide(),i._plainApiKey.hide(),i._plainApiKey.text(""),i._invalidApiKeyMessage.hide(),i._validateApiBtn.show(),e.err?e.err.forEach(function(e){i._invalidApiKeyMessage.text(e).show()}):i._invalidApiKeyMessage.text("Your API key seems invalid.").show()}):(t.prop("disabled",!1),i._loaderSpinner.hide(),i._invalidApiKeyMessage.text("You must insert your API key first").show())}),_(document).on("click","#wcsdm-api-key-modifier",function(e){e.preventDefault(),i._plainApiKey.text(""),i._plainApiKey.hide(),i._changeApiBtn.hide(),i._tableRows.hide(),i._saveBtn.hide(),i._gmapsAPIKeyField.show(),i._validateApiBtn.show()}),_(document).on("change","#woocommerce_wcsdm_gmaps_api_units",function(){switch(_(this).val()){case"metric":_(".field-group.distance .field-group-icon").text("KM"),_('option[value="per_unit"]').text(i._params.txt.per_unit_km);break;default:_(".field-group.distance .field-group-icon").text("MI"),_('option[value="per_unit"]').text(i._params.txt.per_unit_mi)}}),_(document).on("change","#"+i._inputLatSel+", #"+i._inputLngSel,function(){if(_(".gm-err-content").length)return!1;i._initGoogleMaps()}),_(document).on("change","#rates-list-table thead .select-item",i._toggleRateRowsBulk),_(document).on("change","#rates-list-table tbody .select-item",i._toggleRateRows),_(document).on("click","#rates-list-table .button.add_row",i._addRateRows),_(document).on("click","#rates-list-table .button.remove_rows",i._removeRateRows)},_initGoogleMaps:function(){var t=this;_("#"+t._mapWrapperSel).show().siblings(".description").hide();try{if("undefined"==typeof google||void 0===google.maps)throw"google is not defined";t._buildGoogleMaps()}catch(e){if(t._gmapsAPIKey){var n="https://maps.googleapis.com/maps/api/js?key="+t._gmapsAPIKey+"&libraries=geometry,places&&language="+t._params.language;_.getScript(n,function(){t._buildGoogleMaps()})}}},_buildGoogleMaps:function(){var n=this,e=-6.175392,t=106.827153,a=_("#"+n._inputLatSel).val(),i=_("#"+n._inputLngSel).val(),o={lat:a=a.length?parseFloat(a):e,lng:i=i.length?parseFloat(i):t},s=wp.template(n._mapCanvasSel),r=wp.template(n._mapSearchSel);_("#"+n._mapCanvasSel).length||_("#"+n._mapWrapperSel).append(s({map_canvas_id:n._mapCanvasSel}));var d=[],l=new google.maps.Map(document.getElementById(n._mapCanvasSel),{center:o,zoom:n._zoomLevel,mapTypeId:"roadmap"}),c=new google.maps.Marker({map:l,position:o,draggable:!0,icon:n._params.marker}),p=new google.maps.InfoWindow({maxWidth:350});a===e&&i===t?(p.setContent(n._params.txt.drag_marker),p.open(l,c)):n._setLatLng(c.position,c,l,p),google.maps.event.addListener(c,"dragstart",function(){p.close()}),google.maps.event.addListener(c,"dragend",function(e){n._setLatLng(e.latLng,c,l,p)}),d.push(c),_("#"+n._mapSearchSel).length||_("#"+n._mapWrapperSel).append(r({map_search_id:n._mapSearchSel}));var g=document.getElementById(n._mapSearchSel),m=new google.maps.places.SearchBox(g);l.controls[google.maps.ControlPosition.TOP_LEFT].push(g),l.addListener("bounds_changed",function(){m.setBounds(l.getBounds())}),m.addListener("places_changed",function(){var e=m.getPlaces();if(0!==e.length){d.forEach(function(e){e.setMap(null)}),d=[];var t=new google.maps.LatLngBounds;e.forEach(function(e){e.geometry?(c=new google.maps.Marker({map:l,position:e.geometry.location,draggable:!0,icon:n._params.marker}),n._setLatLng(e.geometry.location,c,l,p),google.maps.event.addListener(c,"dragstart",function(){p.close()}),google.maps.event.addListener(c,"dragend",function(e){n._setLatLng(e.latLng,c,l,p)}),d.push(c),e.geometry.viewport?t.union(e.geometry.viewport):t.extend(e.geometry.location)):console.log("Returned place contains no geometry")}),l.fitBounds(t)}}),setInterval(function(){_(".gm-err-content").length&&(_("#"+n._mapWrapperSel).hide().siblings(".description").show(),_("#"+n._mapSearchSel).remove(),google=void 0)},1e3)},_destroyGoogleMaps:function(){var e=_("#wcsdm-map-canvas"),t=_("#wcsdm-map-search");e.length&&(e.remove(),t.remove(),google=void 0)},_setLatLng:function(e,n,a,i){(new google.maps.Geocoder).geocode({latLng:e},function(e,t){t===google.maps.GeocoderStatus.OK&&e[0]&&(i.setContent(e[0].formatted_address),i.open(a,n),n.addListener("click",function(){i.open(a,n)}))}),a.setCenter(e),_("#"+this._inputLatSel).val(e.lat()),_("#"+this._inputLngSel).val(e.lng())},_toggleRateRowsBulk:function(e){var t=_(e.currentTarget),n=t.closest("table").find("tbody input[type=checkbox]");n.length?n.prop("checked",t.is(":checked")).trigger("change"):t.prop("checked",!t.is(":checked"))},_toggleRateRows:function(e){var t=_(e.currentTarget).closest("table"),n=t.find("thead"),a=t.find("tbody"),i=t.find("tfoot");a.find("[type=checkbox]:checked").length?i.find(".add_row").hide("fast",function(){_(this).siblings(".remove_rows").show()}):i.find(".remove_rows").hide("fast",function(){_(this).siblings(".add_row").show()}),a.find("[type=checkbox]:checked").length===a.find("[type=checkbox]").length?n.find("input[type=checkbox]").prop("checked",!0):n.find("input[type=checkbox]").prop("checked",!1)},_addRateRows:function(e){e.preventDefault(),_("#rates-list-table tbody").append(wp.template("rates-list-input-table-row")).find("tr:last-child .field-distance").focus(),_("#woocommerce_wcsdm_gmaps_api_units").trigger("change")},_removeRateRows:function(e){e.preventDefault();var t=_(e.currentTarget),n=t.closest("table");t.hide("fast",function(){_(this).siblings(".add_row").show()}),n.find("thead [type=checkbox]").prop("checked",!1),n.find("tbody [type=checkbox]:checked").each(function(e,t){_(t).closest("tr").remove()})},_encode:function(e){var t,n,a,i,o,s,r,d="",l=0;for(e=this._utf8_encode(e);l<e.length;)i=(t=e.charCodeAt(l++))>>2,o=(3&t)<<4|(n=e.charCodeAt(l++))>>4,s=(15&n)<<2|(a=e.charCodeAt(l++))>>6,r=63&a,isNaN(n)?s=r=64:isNaN(a)&&(r=64),d=d+this._keyStr.charAt(i)+this._keyStr.charAt(o)+this._keyStr.charAt(s)+this._keyStr.charAt(r);return d},_decode:function(e){var t,n,a,i,o,s,r="",d=0;for(e=e.replace(/[^A-Za-z0-9+/=]/g,"");d<e.length;)t=this._keyStr.indexOf(e.charAt(d++))<<2|(i=this._keyStr.indexOf(e.charAt(d++)))>>4,n=(15&i)<<4|(o=this._keyStr.indexOf(e.charAt(d++)))>>2,a=(3&o)<<6|(s=this._keyStr.indexOf(e.charAt(d++))),r+=String.fromCharCode(t),64!==o&&(r+=String.fromCharCode(n)),64!==s&&(r+=String.fromCharCode(a));return r=this._utf8_decode(r)},_utf8_encode:function(e){e=e.replace(/rn/g,"n");for(var t="",n=0;n<e.length;n++){var a=e.charCodeAt(n);a<128?t+=String.fromCharCode(a):(127<a&&a<2048?t+=String.fromCharCode(a>>6|192):(t+=String.fromCharCode(a>>12|224),t+=String.fromCharCode(a>>6&63|128)),t+=String.fromCharCode(63&a|128))}return t},_utf8_decode:function(e){for(var t="",n=0,a=0,i=0,o=0;n<e.length;)(a=e.charCodeAt(n))<128?(t+=String.fromCharCode(a),n++):191<a&&a<224?(i=e.charCodeAt(n+1),t+=String.fromCharCode((31&a)<<6|63&i),n+=2):(i=e.charCodeAt(n+1),o=e.charCodeAt(n+2),t+=String.fromCharCode((15&a)<<12|(63&i)<<6|63&o),n+=3);return t},_validateGmapAPIkey:function(e,t,n){e=e;var a=[],i=document.createElement("iframe"),o='<head><script src="https://maps.googleapis.com/maps/api/js?key='+e+'&libraries=geometry,places&&language=en_US&callback=initMap" async defer><\/script><script>var map;function initMap() { map = new google.maps.Map(document.getElementById(\'map\'), { center: {lat: -34.397, lng: 150.644}, zoom: 8 });}<\/script></head><body><div id="map"></div></body>';i.className="uk-hidden",document.body.appendChild(i),i.contentWindow.console.error=function(e){a.push(e)},i.contentWindow.console.warning=function(){},i.contentWindow.console.log=function(){},i.contentWindow.document.open(),i.contentWindow.document.write(o),i.contentWindow.document.close(),i.onload=function(){setTimeout(function(){document.body.removeChild(i),a.length?n({success:!1,err:a}):t({success:!0,msg:"API KEY good"})},5e3)}},_initSettingElements:function(){var e=this;e._gmapsAPIKeyInput=_(".wcsdm-gmaps-api-key"),e._gmapsAPIKeyFieldset=e._gmapsAPIKeyInput.closest("fieldset"),e._parentApiKeyActivator=e._gmapsAPIKeyInput.closest("tr"),e._gmapsAPIKeyField=_("#woocommerce_wcsdm_gmaps_api_key"),e._gmapsAPIKeyFieldSibling=e._gmapsAPIKeyField.prev(),e._gmapsAPIKey=e._gmapsAPIKeyField.val(),e._saveBtn=_("#btn-ok"),e._plainApiKey=e._createElement({id:"plain-apiKey"}),e._loaderSpinner=e._createElement({id:"wcsdm-spinner",class:"spinner"}),e._validateApiBtn=e._createElement({tag:"button",id:"wcsdm-api-key-validator",class:"button button-primary button-large",text:"Validate API Key",isHidden:!0}),e._changeApiBtn=e._createElement({tag:"button",id:"wcsdm-api-key-modifier",class:"button button-primary button-large",text:"Change API Key",isHidden:!0}),e._invalidApiKeyMessage=e._createElement({tag:"div",class:"notice notice-error wcsdm-error",isHidden:!0}),e._tableRows=e._getTableRowElements({within:".wc-modal-shipping-method-settings",excludedRowsWithElement:["#woocommerce_wcsdm_title","#woocommerce_wcsdm_gmaps_api_key"]}),e._gmapsAPIKeyFieldSibling.after(e._plainApiKey),e._gmapsAPIKeyFieldset.append(e._loaderSpinner),e._gmapsAPIKeyFieldset.append(e._validateApiBtn),e._gmapsAPIKeyFieldset.append(e._changeApiBtn),e._validateApiBtn.before(e._invalidApiKeyMessage)},_createElement:function(e){e=_.extend({},{tag:"div",id:"",class:"",text:"",isHidden:!1},e||{});return _("<"+e.tag+(e.isHidden?' style="display:none;"':"")+(e.id?' id="'+e.id+'"':"")+(e.class?' class="'+e.class+'"':"")+">"+e.text+"</"+e.tag+">")},_getTableRowElements:function(t){if(""===(t=_.extend({},{within:"",excludedRowsWithElement:[]},t||{})).within||!t.within.length)throw"within needs to be defined : _getTableRowElements";if(!t.excludedRowsWithElement.length)return _(t.within).find("tr");if(Array.isArray(t.excludedRowsWithElement)){var e=_(t.within).find("tbody").children("tr");_.each(e,function(e,n){_.each(t.excludedRowsWithElement,function(e,t){_(n).find(t).length&&_(n).addClass("wcsdm-excluded-table-row")})})}return e.not(".wcsdm-excluded-table-row")}};_(document).ready(function(){e.init(wcsdm_params)})}(jQuery);