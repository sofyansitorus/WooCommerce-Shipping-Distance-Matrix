!function(h){"use strict";var e={_inputLatId:"",_inputLngId:"",_mapWrapperId:"",_mapSearchId:"",_mapCanvasId:"",_zoomLevel:16,_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",init:function(e){var p=this;p._params=e,p._inputLatSel="woocommerce_wcsdm_origin_lat",p._inputLngSel="woocommerce_wcsdm_origin_lng",p._mapWrapperSel="wcsdm-map-wrapper",p._mapSearchSel="wcsdm-map-search",p._mapCanvasSel="wcsdm-map-canvas",p._gmapsAPIKey=null,p._params.show_settings&&setTimeout(function(){for(var e=!1,t=h(document).find(".wc-shipping-zone-method-type"),o=0;o<t.length;o++){var n=t[o];if(h(n).text()===p._params.method_title)return h(n).closest("tr").find(".row-actions .wc-shipping-zone-method-settings").trigger("click"),void(e=!0)}e||(h(".wc-shipping-zone-add-method").trigger("click"),h('select[name="add_method_id"]').val(p._params.method_id).trigger("change"))},200),h(document).on("click",".wc-shipping-zone-method-settings",function(){var e=h(this).closest("tr").find(".wc-shipping-zone-method-type").text(),t=h("#woocommerce_wcsdm_gmaps_api_key_activator").closest("tr"),o=h("#woocommerce_wcsdm_gmaps_api_key"),n=o.prev(),a=o.val(),i=h("#btn-ok");if(e!==p._params.method_title)return!1;n.after('<div id="plainApiKey"></div>');var r=h("#plainApiKey");r.hide(),h("#woocommerce_wcsdm_gmaps_api_units").trigger("change"),t.find("fieldset").append('<div style="float:left;visibility:visible;display:none;" class="spinner"></div><button style="display:none;" id="wcsdm-api-key-validator" class="button button-primary button-large">Validate API Key</button><button style="display:none;" id="wcsdm-api-key-modifier" class="button button-primary button-large">Change API Key</button>');var s=h("#wcsdm-api-key-validator"),c=h("#wcsdm-api-key-modifier");if(s.hide(),c.hide(),a.length)c.show(),o.hide(),i.show(),p._gmapsAPIKey=a,r.text(a),r.show(),p._initGoogleMaps();else{s.show(),r.hide(),r.text("");var d=h(".wcsdm-hide-element").closest("tr"),l=t.nextAll("tr");l.addClass("wcsdm-hide-element"),d.addClass("wcsdm-hide-element"),d.hide(),l.hide(),i.hide()}}),h(document).on("click","#wcsdm-api-key-validator",function(e){e.preventDefault();var t=h(this);t.prop("disabled",!0);var o=h("#woocommerce_wcsdm_gmaps_api_key"),n=(o.prev(),o.val()),a=h("#woocommerce_wcsdm_gmaps_api_key_activator"),i=a.closest("tr").find(".spinner"),r=h(".notice-error"),s=h("#wcsdm-api-key-validator"),c=h("#wcsdm-api-key-modifier"),d=h("#btn-ok"),l=h("#plainApiKey");r.length&&r.remove(),i.show(),n.length?new Promise(function(e,t){p._gmapsAPIKey===n&&e(n),p._validateGmapAPIkey(n,e,t)}).then(function(e){t.prop("disabled",!1),i.hide(),h(".wcsdm-hide-element").show(),o.hide(),s.hide(),c.show(),l.text(n),l.show(),d.show(),p._gmapsAPIKey!==n&&(p._destroyGoogleMaps(),p._gmapsAPIKey=n),p._initGoogleMaps()}).catch(function(e){r.length&&r.remove(),t.prop("disabled",!1),i.hide(),l.hide(),l.text(""),s.show(),c.hide(),e.err?e.err.forEach(function(e){a.before('<div style="margin-left:0;margin-bottom:10px;" class="notice notice-error">'+e+"</div>")}):a.before('<div style="margin-left:0;margin-bottom:10px;" class="notice notice-error">Your API key seems invalid.</div>')}):(t.prop("disabled",!1),i.hide(),a.before('<div style="margin-left:0;margin-bottom:10px;" class="notice notice-error">You must insert your API key first.</div>'))}),h(document).on("click","#wcsdm-api-key-modifier",function(e){e.preventDefault();var t=h("#woocommerce_wcsdm_gmaps_api_key"),o=(t.val(),h("#woocommerce_wcsdm_gmaps_api_key_activator").closest("tr")),n=h("#btn-ok"),a=h(".wcsdm-hide-element").closest("tr"),i=o.nextAll("tr"),r=h("#plainApiKey");r.text(""),r.hide(),t.show(),h("#wcsdm-api-key-validator").show(),h("#wcsdm-api-key-modifier").hide(),i.addClass("wcsdm-hide-element"),a.addClass("wcsdm-hide-element"),a.hide(),i.hide(),n.hide()}),h(document).on("change","#woocommerce_wcsdm_gmaps_api_units",function(){switch(h(this).val()){case"metric":h(".field-group.distance .field-group-icon").text("KM"),h('option[value="per_unit"]').text(p._params.txt.per_unit_km);break;default:h(".field-group.distance .field-group-icon").text("MI"),h('option[value="per_unit"]').text(p._params.txt.per_unit_mi)}}),h(document).on("change","#"+p._inputLatSel+", #"+p._inputLngSel,function(){if(h(".gm-err-content").length)return!1;p._initGoogleMaps()}),h(document).on("change","#rates-list-table thead .select-item",p._toggleRateRowsBulk),h(document).on("change","#rates-list-table tbody .select-item",p._toggleRateRows),h(document).on("click","#rates-list-table .button.add_row",p._addRateRows),h(document).on("click","#rates-list-table .button.remove_rows",p._removeRateRows)},_initGoogleMaps:function(){var t=this;h("#"+t._mapWrapperSel).show().siblings(".description").hide();try{if("undefined"==typeof google||void 0===google.maps)throw"google is not defined";t._buildGoogleMaps()}catch(e){if(t._gmapsAPIKey){var o="https://maps.googleapis.com/maps/api/js?key="+t._gmapsAPIKey+"&libraries=geometry,places&&language="+t._params.language;h.getScript(o,function(){t._buildGoogleMaps()})}}},_buildGoogleMaps:function(){var o=this,e=-6.175392,t=106.827153,n=h("#"+o._inputLatSel).val(),a=h("#"+o._inputLngSel).val(),i={lat:n=n.length?parseFloat(n):e,lng:a=a.length?parseFloat(a):t},r=wp.template(o._mapCanvasSel),s=wp.template(o._mapSearchSel);h("#"+o._mapCanvasSel).length||h("#"+o._mapWrapperSel).append(r({map_canvas_id:o._mapCanvasSel}));var c=[],d=new google.maps.Map(document.getElementById(o._mapCanvasSel),{center:i,zoom:o._zoomLevel,mapTypeId:"roadmap"}),l=new google.maps.Marker({map:d,position:i,draggable:!0,icon:o._params.marker}),p=new google.maps.InfoWindow({maxWidth:350});n===e&&a===t?(p.setContent(o._params.txt.drag_marker),p.open(d,l)):o._setLatLng(l.position,l,d,p),google.maps.event.addListener(l,"dragstart",function(){p.close()}),google.maps.event.addListener(l,"dragend",function(e){o._setLatLng(e.latLng,l,d,p)}),c.push(l),h("#"+o._mapSearchSel).length||h("#"+o._mapWrapperSel).append(s({map_search_id:o._mapSearchSel}));var m=document.getElementById(o._mapSearchSel),g=new google.maps.places.SearchBox(m);d.controls[google.maps.ControlPosition.TOP_LEFT].push(m),d.addListener("bounds_changed",function(){g.setBounds(d.getBounds())}),g.addListener("places_changed",function(){var e=g.getPlaces();if(0!==e.length){c.forEach(function(e){e.setMap(null)}),c=[];var t=new google.maps.LatLngBounds;e.forEach(function(e){e.geometry?(l=new google.maps.Marker({map:d,position:e.geometry.location,draggable:!0,icon:o._params.marker}),o._setLatLng(e.geometry.location,l,d,p),google.maps.event.addListener(l,"dragstart",function(){p.close()}),google.maps.event.addListener(l,"dragend",function(e){o._setLatLng(e.latLng,l,d,p)}),c.push(l),e.geometry.viewport?t.union(e.geometry.viewport):t.extend(e.geometry.location)):console.log("Returned place contains no geometry")}),d.fitBounds(t)}}),setInterval(function(){h(".gm-err-content").length&&(h("#"+o._mapWrapperSel).hide().siblings(".description").show(),h("#"+o._mapSearchSel).remove(),google=void 0)},1e3)},_destroyGoogleMaps:function(){var e=h("#wcsdm-map-canvas"),t=h("#wcsdm-map-search");e.length&&(e.remove(),t.remove(),google=void 0)},_setLatLng:function(e,o,n,a){(new google.maps.Geocoder).geocode({latLng:e},function(e,t){t===google.maps.GeocoderStatus.OK&&e[0]&&(a.setContent(e[0].formatted_address),a.open(n,o),o.addListener("click",function(){a.open(n,o)}))}),n.setCenter(e),h("#"+this._inputLatSel).val(e.lat()),h("#"+this._inputLngSel).val(e.lng())},_toggleRateRowsBulk:function(e){var t=h(e.currentTarget),o=t.closest("table").find("tbody input[type=checkbox]");o.length?o.prop("checked",t.is(":checked")).trigger("change"):t.prop("checked",!t.is(":checked"))},_toggleRateRows:function(e){var t=h(e.currentTarget).closest("table"),o=t.find("thead"),n=t.find("tbody"),a=t.find("tfoot");n.find("[type=checkbox]:checked").length?a.find(".add_row").hide("fast",function(){h(this).siblings(".remove_rows").show()}):a.find(".remove_rows").hide("fast",function(){h(this).siblings(".add_row").show()}),n.find("[type=checkbox]:checked").length===n.find("[type=checkbox]").length?o.find("input[type=checkbox]").prop("checked",!0):o.find("input[type=checkbox]").prop("checked",!1)},_addRateRows:function(e){e.preventDefault(),h("#rates-list-table tbody").append(wp.template("rates-list-input-table-row")).find("tr:last-child .field-distance").focus(),h("#woocommerce_wcsdm_gmaps_api_units").trigger("change")},_removeRateRows:function(e){e.preventDefault();var t=h(e.currentTarget),o=t.closest("table");t.hide("fast",function(){h(this).siblings(".add_row").show()}),o.find("thead [type=checkbox]").prop("checked",!1),o.find("tbody [type=checkbox]:checked").each(function(e,t){h(t).closest("tr").remove()})},_encode:function(e){var t,o,n,a,i,r,s,c="",d=0;for(e=this._utf8_encode(e);d<e.length;)a=(t=e.charCodeAt(d++))>>2,i=(3&t)<<4|(o=e.charCodeAt(d++))>>4,r=(15&o)<<2|(n=e.charCodeAt(d++))>>6,s=63&n,isNaN(o)?r=s=64:isNaN(n)&&(s=64),c=c+this._keyStr.charAt(a)+this._keyStr.charAt(i)+this._keyStr.charAt(r)+this._keyStr.charAt(s);return c},_decode:function(e){var t,o,n,a,i,r,s="",c=0;for(e=e.replace(/[^A-Za-z0-9+/=]/g,"");c<e.length;)t=this._keyStr.indexOf(e.charAt(c++))<<2|(a=this._keyStr.indexOf(e.charAt(c++)))>>4,o=(15&a)<<4|(i=this._keyStr.indexOf(e.charAt(c++)))>>2,n=(3&i)<<6|(r=this._keyStr.indexOf(e.charAt(c++))),s+=String.fromCharCode(t),64!==i&&(s+=String.fromCharCode(o)),64!==r&&(s+=String.fromCharCode(n));return s=this._utf8_decode(s)},_utf8_encode:function(e){e=e.replace(/rn/g,"n");for(var t="",o=0;o<e.length;o++){var n=e.charCodeAt(o);n<128?t+=String.fromCharCode(n):(127<n&&n<2048?t+=String.fromCharCode(n>>6|192):(t+=String.fromCharCode(n>>12|224),t+=String.fromCharCode(n>>6&63|128)),t+=String.fromCharCode(63&n|128))}return t},_utf8_decode:function(e){for(var t="",o=0,n=0,a=0,i=0;o<e.length;)(n=e.charCodeAt(o))<128?(t+=String.fromCharCode(n),o++):191<n&&n<224?(a=e.charCodeAt(o+1),t+=String.fromCharCode((31&n)<<6|63&a),o+=2):(a=e.charCodeAt(o+1),i=e.charCodeAt(o+2),t+=String.fromCharCode((15&n)<<12|(63&a)<<6|63&i),o+=3);return t},_validateGmapAPIkey:function(e,t,o){e=e;var n=[],a=document.createElement("iframe"),i='<head><script src="https://maps.googleapis.com/maps/api/js?key='+e+'&libraries=geometry,places&&language=en_US&callback=initMap" async defer><\/script><script>var map;function initMap() { map = new google.maps.Map(document.getElementById(\'map\'), { center: {lat: -34.397, lng: 150.644}, zoom: 8 });}<\/script></head><body><div id="map"></div></body>';a.className="uk-hidden",document.body.appendChild(a),a.contentWindow.console.error=function(e){n.push(e)},a.contentWindow.console.warning=function(){},a.contentWindow.console.log=function(){},a.contentWindow.document.open(),a.contentWindow.document.write(i),a.contentWindow.document.close(),a.onload=function(){setTimeout(function(){document.body.removeChild(a),n.length?o({success:!1,err:n}):t({success:!0,msg:"API KEY good"})},5e3)}}};h(document).ready(function(){e.init(wcsdm_params)})}(jQuery);